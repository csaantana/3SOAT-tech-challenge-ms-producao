<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="pt"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PagamentoService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">tech-challenge</a> &gt; <a href="index.source.html" class="el_package">br.com.tech.challenge.servicos</a> &gt; <span class="el_source">PagamentoService.java</span></div><h1>PagamentoService.java</h1><pre class="source lang-java linenums">package br.com.tech.challenge.servicos;

import br.com.tech.challenge.api.client.MercadoPagoClient;
import br.com.tech.challenge.api.exception.ObjectNotFoundException;
import br.com.tech.challenge.bd.repositorios.PagamentoRepository;
import br.com.tech.challenge.bd.repositorios.PedidoRepository;
import br.com.tech.challenge.domain.dto.external.CashOutDTO;
import br.com.tech.challenge.domain.dto.external.ItemDTO;
import br.com.tech.challenge.domain.dto.external.MercadoPagoRequestDTO;
import br.com.tech.challenge.domain.dto.external.MercadoPagoResponseDTO;
import br.com.tech.challenge.domain.entidades.Pagamento;
import br.com.tech.challenge.domain.entidades.Pedido;
import br.com.tech.challenge.domain.enums.StatusPagamento;
import br.com.tech.challenge.domain.enums.StatusPedido;
import lombok.Generated;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.math.BigDecimal;
import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.List;

@Service
@RequiredArgsConstructor
public class PagamentoService {

    private final PagamentoRepository pagamentoRepository;

    private final MercadoPagoClient mercadoPagoClient;

    private final PedidoRepository pedidoRepository;

    private final ProdutoService produtoService;

    @Transactional
    public Pagamento save(Pedido pedido) {
<span class="fc" id="L39">        var pagamento = Pagamento.builder()</span>
<span class="fc" id="L40">                .pedido(pedido)</span>
<span class="fc" id="L41">                .valorTotal(pedido.getValorTotal())</span>
<span class="fc" id="L42">                .statusPagamento(StatusPagamento.AGUARDANDO_PAGAMENTO)</span>
<span class="fc" id="L43">                .build();</span>
<span class="fc" id="L44">        return pagamentoRepository.save(pagamento);</span>
    }

    public Pagamento findPagamentoByPedidoId(Long idPedido) {
<span class="pc" id="L48">        return pagamentoRepository.findPagamentoByPedidoId(idPedido).orElseThrow(() -&gt; new ObjectNotFoundException(&quot;Pagamento nÃ£o encontrado.&quot;));</span>
    }

    @Transactional
    @Generated
    public MercadoPagoResponseDTO generateQRCode(Long idPedido) {
        var pedido = getPedido(idPedido);
        var requestDTO = buildMercadoPagoRequestDTO(pedido);
        var responseDTO = mercadoPagoClient.generateQRCode(requestDTO);

        var pagamento = findPagamentoByPedidoId(pedido.getId());
        pagamento.setQrData(responseDTO.getQrData());

        pagamentoRepository.save(pagamento);
        return responseDTO;
    }

    @Transactional
    public Pagamento checkout(Long idPedido) {
<span class="fc" id="L67">        var pedido = getPedido(idPedido);</span>
<span class="fc" id="L68">        var pagamento = findPagamentoByPedidoId(pedido.getId());</span>

<span class="fc" id="L70">        pagamento.setStatusPagamento(StatusPagamento.PAGO);</span>
<span class="fc" id="L71">        pagamento.setDataHoraPagamento(LocalDateTime.now());</span>

<span class="fc" id="L73">        pedido.setStatusPedido(StatusPedido.EM_PREPARACAO);</span>
<span class="fc" id="L74">        pedidoRepository.save(pedido);</span>
<span class="fc" id="L75">        return pagamentoRepository.save(pagamento);</span>
    }

    @Generated
    private MercadoPagoRequestDTO buildMercadoPagoRequestDTO(Pedido pedido) {
        var pagamento = findPagamentoByPedidoId(pedido.getId());
        var produtos = pedido.getProdutos();

        List&lt;ItemDTO&gt; items = new ArrayList&lt;&gt;();
        produtos.forEach((produto) -&gt; {
<span class="nc" id="L85">            var count = produtoService.count(produto.getId(), produtos);</span>
<span class="nc" id="L86">            items.add(ItemDTO.builder()</span>
<span class="nc" id="L87">                    .category(produto.getCategoria().getDescricao())</span>
<span class="nc" id="L88">                    .title(produto.getDescricao() + &quot; do pedido &quot; + pedido.getSenhaRetirada())</span>
<span class="nc" id="L89">                    .description(produto.getDescricao())</span>
<span class="nc" id="L90">                    .unitPrice(produto.getValorUnitario())</span>
<span class="nc" id="L91">                    .quantity(count)</span>
<span class="nc" id="L92">                    .unitMeasure(&quot;unit&quot;)</span>
<span class="nc" id="L93">                    .totalAmount(produto.getValorUnitario().multiply(BigDecimal.valueOf(count)))</span>
<span class="nc" id="L94">                    .build()</span>
            );
<span class="nc" id="L96">        });</span>

        return MercadoPagoRequestDTO.builder()
                .externalReference(pedido.getSenhaRetirada().toString())
                .title(&quot;Ordem de pedido&quot;)
                .description(String.format(&quot;Pagamento %d do Pedido %d&quot;, pagamento.getId(), pedido.getId()))
                .totalAmount(pagamento.getValorTotal().multiply(BigDecimal.valueOf(2L)))
                .items(items)
                .cashOut(CashOutDTO.builder().amount(pagamento.getValorTotal()).build())
                .build();
    }

    @Generated
    private Pedido getPedido(Long idPedido) {
<span class="nc" id="L110">        return pedidoRepository.findById(idPedido).orElseThrow(() -&gt; new ObjectNotFoundException(&quot;Pedido nÃ£o encontrado.&quot;));</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.9.202303310957</span></div></body></html>